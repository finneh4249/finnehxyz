---
import ThemeSwitcher from './ThemeSwitcher.astro';
import ScrollProgressBar from './ScrollProgressBar.astro';
import { Icon } from 'astro-icon/components';

const navLinks = [
  { id: 'hero', label: 'Home', type: 'anchor' },
  { id: 'aboutme', label: 'About', type: 'anchor' },
  { id: 'professionalExperience', label: 'Experience', type: 'anchor' },
  { id: 'education', label: 'Education', type: 'anchor' },
  { id: 'skills', label: 'Skills', type: 'anchor' },
  { id: 'projects', label: 'Projects', type: 'anchor' },
  { href: '/blog', label: 'Blog', type: 'page' },
  { id: 'contact', label: 'Contact', type: 'anchor' }
];

interface Props {
  activeSection?: string;
}

const { activeSection } = Astro.props;
---

<nav
  id="main-nav"
  class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 transition-all duration-300"
>
  <ScrollProgressBar className="fixed top-0 left-0 w-full z-[60]" />
  
  <!-- Floating Dock Container -->
  <div class="bg-white dark:bg-zinc-900 border-4 border-black dark:border-white shadow-brutal-xl p-2 flex items-center gap-2 md:gap-4 rounded-none transform hover:-translate-y-1 transition-transform duration-200">
    
    <!-- Logo / Home -->
    <a 
      href="#hero" 
      id="nav-logo"
      class="brutal-btn bg-neo-yellow text-black w-12 h-12 flex items-center justify-center border-2 !shadow-none hover:!bg-black hover:!text-neo-yellow transition-colors"
      title="Home"
    >
      <span class="font-black text-xl">EC</span>
    </a>

    <!-- Desktop Links -->
    <div class="hidden md:flex items-center gap-2">
      {navLinks.map(link => (
        <a
          href={link.type === 'page' ? link.href : `#${link.id}`}
          class:list={[
            "px-4 py-2 font-bold uppercase text-sm border-2 border-transparent hover:border-black dark:hover:border-white hover:bg-gray-100 dark:hover:bg-zinc-800 transition-all",
            activeSection === link.id ? 'bg-black text-white dark:bg-white dark:text-black' : 'text-black dark:text-white'
          ]}
          data-id={link.id}
        >
          {link.label}
        </a>
      ))}
    </div>

    <!-- Mobile Menu Toggle -->
    <button 
      id="mobile-menu-toggle"
      class="md:hidden brutal-btn bg-white dark:bg-zinc-900 w-12 h-12 p-0 flex items-center justify-center border-2 !shadow-none text-black dark:text-white relative overflow-hidden"
      aria-label="Toggle menu"
    >
      <Icon name="mdi:menu" class="w-8 h-8 text-black dark:text-white absolute transition-all duration-300 menu-icon-open" style="color: inherit;" />
      <Icon name="mdi:close" class="w-8 h-8 text-black dark:text-white absolute transition-all duration-300 menu-icon-close opacity-0 rotate-90 scale-50" style="color: inherit;" />
    </button>

    <!-- Theme Switcher -->
    <div class="border-l-2 border-black dark:border-white pl-2">
      <ThemeSwitcher />
    </div>
  </div>

  <!-- Mobile Menu (Popup from bottom) -->
  <div 
    id="mobile-menu"
    class="absolute bottom-full left-0 w-full mb-4 bg-white dark:bg-zinc-900 border-4 border-black dark:border-white shadow-brutal-xl p-4 transform scale-y-0 origin-bottom transition-transform duration-200 md:hidden"
  >
    <ul class="space-y-2">
      {navLinks.map(link => (
        <li>
          <a 
            href={link.type === 'page' ? link.href : `#${link.id}`}
            class:list={[
              "block w-full text-center py-3 font-bold uppercase border-2 border-transparent hover:border-black dark:hover:border-white hover:bg-gray-100 dark:hover:bg-zinc-800",
              activeSection === link.id ? 'bg-black text-white dark:bg-white dark:text-black' : 'text-black dark:text-white'
            ]}
          >
            {link.label}
          </a>
        </li>
      ))}
    </ul>
  </div>
</nav>

<script>
  function initNavbar() {
    const nav = document.getElementById('main-nav');
    const toggleBtn = document.getElementById('mobile-menu-toggle');
    const menu = document.getElementById('mobile-menu');
    
    if (!nav || !toggleBtn || !menu) return;

    const menuIconOpen = toggleBtn.querySelector('.menu-icon-open');
    const menuIconClose = toggleBtn.querySelector('.menu-icon-close');

    let isMenuOpen = false;

    const toggleMenu = () => {
      isMenuOpen = !isMenuOpen;
      if (isMenuOpen) {
        menu.classList.remove('scale-y-0');
        toggleBtn.classList.add('bg-black', 'text-white');
        toggleBtn.classList.remove('bg-white', 'dark:bg-zinc-900');
        
        if (menuIconOpen && menuIconClose) {
          menuIconOpen.classList.add('opacity-0', 'rotate-90', 'scale-50');
          menuIconClose.classList.remove('opacity-0', 'rotate-90', 'scale-50');
        }
      } else {
        menu.classList.add('scale-y-0');
        toggleBtn.classList.remove('bg-black', 'text-white');
        toggleBtn.classList.add('bg-white', 'dark:bg-zinc-900');
        
        if (menuIconOpen && menuIconClose) {
          menuIconOpen.classList.remove('opacity-0', 'rotate-90', 'scale-50');
          menuIconClose.classList.add('opacity-0', 'rotate-90', 'scale-50');
        }
      }
    };

    toggleBtn.addEventListener('click', toggleMenu);

    // Close menu when clicking a link
    menu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        if (isMenuOpen) toggleMenu();
      });
    });

    // Active Section Highlighting
    const observerOptions = {
      root: null,
      rootMargin: '-20% 0px -70% 0px',
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          updateActiveLink(id);
        }
      });
    }, observerOptions);

    document.querySelectorAll('section[id]').forEach(section => {
      observer.observe(section);
    });

    function updateActiveLink(id) {
      document.querySelectorAll('[data-id]').forEach(link => {
        const href = link.getAttribute('href');
        if (href === `#${id}`) {
          link.classList.add('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
          link.classList.remove('text-black', 'dark:text-white');
        } else {
          link.classList.remove('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
          link.classList.add('text-black', 'dark:text-white');
        }
      });
    }
  }

  initNavbar();
  document.addEventListener('astro:page-load', initNavbar);
</script>